AWSTemplateFormatVersion: 2010-09-09
Description: security alarm

Parameters:
  TrailLogGroupName:
    Type: String
  MetricNamespace:
    Type: String
    Default: TrailLogMetrics
  SNSTopicName:
    Type: String
    Default: SecurityAlarm
  SNSDisplayName:
    Type: String
    Default: SecurityAlarm
  # 通知先が複数ならばメーリングリストが良い
  SecurityAlarmEmailAddress: 
    Type: String
    Default: '{{resolve:ssm:SecurityAlarmEmailAddress:1}}'

Resources:
  SecurityAlarmSNS:
    Type: "AWS::SNS::Topic"
    Properties:
      TopicName: !Ref SNSTopicName
      DisplayName: !Ref SNSDisplayName
      # SNSの暗号化とは？
      # KmsMasterKeyId: String
      Subscription:
        - Endpoint: !Ref SecurityAlarmEmailAddress
          Protocol: email
  
  #----------------------------------------------------------------------------
  # 許可されていないAPIコールに対するアラーム通知設定
  #----------------------------------------------------------------------------
  UnauthorizedAPICallsFilter:
    Type: "AWS::Logs::MetricFilter"
    Properties:
      FilterPattern: '{($.errorCode="*UnauthorizedOperation") || ($.errorCode="AccessDenied*")}'
      LogGroupName: !Ref TrailLogGroupName
      MetricTransformations:
        - MetricNamespace: !Ref MetricNamespace
          MetricName: UnauthorizedAPICalls
          MetricValue: '1'
  
  UnauthorizedAPICallsAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      AlarmName: UnauthorizedAPICallsAlarm
      AlarmDescription: Alarm cloudtrail detected unauthorized API calls
      ActionsEnabled: true
      Namespace: !Ref MetricNamespace
      MetricName: UnauthorizedAPICalls
      AlarmActions:
        - !Ref SecurityAlarmSNS
      ComparisonOperator: GreaterThanOrEqualToThreshold 
      # 以下2つのみをもう少し詳しく知りたい
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 300
      Statistic: Sum
      Threshold: 1
      TreatMissingData: notBreaching

  #----------------------------------------------------------------------------
  # MFAなしでのAWSマネージメントコンソールログインに対してのアラーム通知設定
  #----------------------------------------------------------------------------
  LoginWithoutMFAFilter:
    Type: "AWS::Logs::MetricFilter"
    Properties:
      FilterPattern: '{($.eventName = "ConsoleLogin") && ($.additionalEventData.MFAUsed != "Yes")}'
      LogGroupName: !Ref TrailLogGroupName
      MetricTransformations:
        - MetricNamespace: !Ref MetricNamespace
          MetricName: LoginWithoutMFA
          MetricValue: '1'
  
  LoginWithoutMFAAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      AlarmName: LoginWithoutMFAAlarm
      AlarmDescription: Alarm cloudtrail detected console login without MFA
      ActionsEnabled: true
      Namespace: !Ref MetricNamespace
      MetricName: LoginWithoutMFA
      AlarmActions:
        - !Ref SecurityAlarmSNS
      ComparisonOperator: GreaterThanOrEqualToThreshold 
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 300
      Statistic: Sum
      Threshold: 1
      TreatMissingData: notBreaching

  #----------------------------------------------------------------------------
  # IAMポリシーの変更を検知するアラーム
  #----------------------------------------------------------------------------
  IAMPolicyChangeFilter:
    Type: "AWS::Logs::MetricFilter"
    Properties:
      FilterPattern: >-
        {($.eventName=DeleteGroupPolicy) || ($.eventName=DeleteRolePolicy)
        || ($.eventName=DeleteUserPolicy) || ($.eventName=PutGroupPolicy)
        || ($.eventName=PutRolePolicy) || ($.eventName=PutUserPolicy)
        || ($.eventName=CreatePolicy) || ($.eventName=DeletePolicy)
        || ($.eventName=CreatePolicyVersion) || ($.eventName=DeletePolicyVersion)
        || ($.eventName=AttachRolePolicy) || ($.eventName=DetachRolePolicy)
        || ($.eventName=AttachUserPolicy) || ($.eventName=DetachUserPolicy)
        || ($.eventName=AttachGroupPolicy) || ($.eventName=DetachGroupPolicy)}
      LogGroupName: !Ref TrailLogGroupName
      MetricTransformations:
        - MetricNamespace: !Ref MetricNamespace
          MetricName: IAMPolicyChange
          MetricValue: '1'
  
  IAMPolicyChangeAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      AlarmName: IAMPolicyChangeAlarm
      AlarmDescription: Alarm cloudtrail detected　IAM policy changes 
      ActionsEnabled: true
      Namespace: !Ref MetricNamespace
      MetricName: IAMPolicyChange
      AlarmActions:
        - !Ref SecurityAlarmSNS
      ComparisonOperator: GreaterThanOrEqualToThreshold 
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 300
      Statistic: Sum
      Threshold: 1
      TreatMissingData: notBreaching
  
  
  #----------------------------------------------------------------------------
  # CloudTrail設定の変更を検知するアラーム
  #----------------------------------------------------------------------------
  CloudTrailConfigChangeFilter :
    Type: "AWS::Logs::MetricFilter"
    Properties:
      FilterPattern: >-
        {($.eventName = CreateTrail) || ($.eventName = UpdateTrail)
        || ($.eventName =DeleteTrail) || ($.eventName = StartLogging) 
        || ($.eventName = StopLogging)}
      LogGroupName: !Ref TrailLogGroupName
      MetricTransformations:
        - MetricNamespace: !Ref MetricNamespace
          MetricName: CloudTrailConfigChange
          MetricValue: '1'
  
  CloudTrailConfigChangeAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      AlarmName: CloudTrailConfigChangeAlarm
      AlarmDescription: Alarm cloudtrail detected　CloudTrail config changes 
      ActionsEnabled: true
      Namespace: !Ref MetricNamespace
      MetricName: CloudTrailConfigChange
      AlarmActions:
        - !Ref SecurityAlarmSNS
      ComparisonOperator: GreaterThanOrEqualToThreshold 
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 300
      Statistic: Sum
      Threshold: 1
      TreatMissingData: notBreaching
  
  #----------------------------------------------------------------------------
  # AWSマネージメントコンソールのログイン失敗を検知するアラーム
  #----------------------------------------------------------------------------
  ManagementConsoleAuthFailureFilter:
    Type: "AWS::Logs::MetricFilter"
    Properties:
      FilterPattern: '{($.eventName = ConsoleLogin) && ($.errorMessage = "Failed authentication")}'
      LogGroupName: !Ref TrailLogGroupName
      MetricTransformations:
        - MetricNamespace: !Ref MetricNamespace
          MetricName: ManagementConsoleAuthFailure
          MetricValue: '1'
    
  ManagementConsoleAuthFailureAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      AlarmName: ManagementConsoleAuthFailureAlarm
      AlarmDescription: Alarm cloudtrail detected management console login failure 
      ActionsEnabled: true
      Namespace: !Ref MetricNamespace
      MetricName: ManagementConsoleAuthFailure
      AlarmActions:
        - !Ref SecurityAlarmSNS
      ComparisonOperator: GreaterThanOrEqualToThreshold 
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 300
      Statistic: Sum
      Threshold: 1
      TreatMissingData: notBreaching
  

  #----------------------------------------------------------------------------
  # KMSマスターキー(CMK)の無効化またはスケジュール削除を検知するアラーム
  #----------------------------------------------------------------------------
  CMKChangeFilter:
    Type: "AWS::Logs::MetricFilter"
    Properties:
      FilterPattern: >-
        {($.eventSource = kms.amazonaws.com) &&
        (($.eventName=DisableKey)||($.eventName=ScheduleKeyDeletion))}
      LogGroupName: !Ref TrailLogGroupName
      MetricTransformations:
        - MetricNamespace: !Ref MetricNamespace
          MetricName: CMKChange
          MetricValue: '1'
    
  CMKChangeAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      AlarmName: CMKChangeAlarm
      AlarmDescription: Alarm cloudtrail detected CMK changes
      ActionsEnabled: true
      Namespace: !Ref MetricNamespace
      MetricName: CMKChange
      AlarmActions:
        - !Ref SecurityAlarmSNS
      ComparisonOperator: GreaterThanOrEqualToThreshold 
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 300
      Statistic: Sum
      Threshold: 1
      TreatMissingData: notBreaching
  

  #----------------------------------------------------------------------------
  # S3バケットポリシー変更を検知するアラーム
  #----------------------------------------------------------------------------
  S3BucketPolicyChangeFilter:
    Type: "AWS::Logs::MetricFilter"
    Properties:
      FilterPattern: >-
        { ($.eventSource = s3.amazonaws.com) && 
        (($.eventName = PutBucketAcl) || ($.eventName = PutBucketPolicy)
        || ($.eventName = PutBucketCors) || ($.eventName = PutBucketLifecycle) 
        || ($.eventName = PutBucketReplication) || ($.eventName = DeleteBucketPolicy) 
        || ($.eventName = DeleteBucketCors) || ($.eventName = DeleteBucketLifecycle) 
        || ($.eventName = DeleteBucketReplication)) }
      LogGroupName: !Ref TrailLogGroupName
      MetricTransformations:
        - MetricNamespace: !Ref MetricNamespace
          MetricName: S3BucketPolicyChange
          MetricValue: '1'
    
  S3BucketPolicyChangeAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      AlarmName: S3BucketPolicyChange
      AlarmDescription: Alarm cloudtrail detected S3Bucket policy changes
      ActionsEnabled: true
      Namespace: !Ref MetricNamespace
      MetricName: S3BucketPolicyChange
      AlarmActions:
        - !Ref SecurityAlarmSNS
      ComparisonOperator: GreaterThanOrEqualToThreshold 
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 300
      Statistic: Sum
      Threshold: 1
      TreatMissingData: notBreaching